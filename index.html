<!doctype html>
<html lang="vi">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th·ªùi Gian Bi·ªÉu H·ªçc Th√™m</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&amp;display=swap" rel="stylesheet">
  <style>
        body {
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .time-slot {
            min-height: 80px;
            border: 2px solid #e5e7eb;
        }
        .last-row td:first-child {
            border-bottom-left-radius: 1rem;
        }
        .last-row td:last-child {
            border-bottom-right-radius: 1rem;
        }
        .editable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .editable:hover {
            background-color: #f3f4f6;
        }
        .time-slot:hover .opacity-0 {
            opacity: 1;
        }
        .delete-btn {
            transition: all 0.2s;
        }
        .delete-btn:hover {
            transform: scale(1.1);
        }
        .editing {
            background-color: #dbeafe !important;
            border: 2px solid #3b82f6;
        }
        .mobile-schedule {
            width: 1080px;
            height: 1920px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -1;
        }
        .mobile-schedule .schedule-title {
            color: white;
            font-size: 48px;
            font-weight: bold;
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .mobile-schedule .time-block {
            background: rgba(255,255,255,0.95);
            border-radius: 20px;
            margin-bottom: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }
        .mobile-schedule .time-header {
            font-size: 32px;
            font-weight: bold;
            color: #4a5568;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 3px solid #e2e8f0;
            padding-bottom: 15px;
        }
        .mobile-schedule .day-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .mobile-schedule .day-item {
            background: #f7fafc;
            border-radius: 12px;
            padding: 15px;
            border-left: 5px solid #4299e1;
        }
        .mobile-schedule .day-name {
            font-size: 20px;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 8px;
        }
        .mobile-schedule .subject {
            font-size: 18px;
            color: #4a5568;
            margin-bottom: 5px;
        }
        .mobile-schedule .address {
            font-size: 14px;
            color: #718096;
            margin-bottom: 10px;
        }
        .mobile-schedule .tasks {
            font-size: 14px;
        }
        .mobile-schedule .task-item {
            margin: 3px 0;
            color: #2d3748;
        }
        .mobile-schedule .task-completed {
            text-decoration: line-through;
            color: #68d391;
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="/_sdk/element_sdk.js" type="text/javascript"></script>
 </head>
 <body class="bg-gray-50 min-h-full">
  <main class="container mx-auto px-4 py-8">
   <header class="text-center mb-8 relative">
    <div class="absolute top-0 left-0"><a href="https://nckhthptnk.github.io/minitkb/" target="_blank" rel="noopener noreferrer" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg font-medium transition-colors shadow-md hover:shadow-lg inline-flex items-center gap-2"> üè† Trang ch·ªß </a>
    </div>
    <h1 class="text-3xl font-bold mb-2">üìã <span style="background: linear-gradient(135deg, #ff6b9d, #c44569); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">L·ªãch Tr√¨nh C√° Nh√¢n</span></h1>
    <p class="text-gray-600">Nh·∫•p v√†o √¥ ƒë·ªÉ ch·ªânh s·ª≠a th√¥ng tin</p>
   </header>
   <div class="mb-6 bg-white rounded-lg p-4 shadow-md">
    <h3 class="text-lg font-semibold text-gray-800 mb-3">üé® Ch·ªçn m√†u ti√™u ƒë·ªÅ:</h3>
    <div class="flex flex-wrap gap-3 justify-center mb-4"><button onclick="changeHeaderColor('buttercup')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #fffbeb;" title="Buttercup - V√†ng r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('soft-peach')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #fff7ed;" title="Soft Peach - Cam r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('pale-pink')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #fdf2f8;" title="Pale Pink - H·ªìng r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('lavender')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #f5f3ff;" title="Lavender - T√≠m r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('cool-aqua')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #f0fdfa;" title="Cool Aqua - Xanh r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('meadow-green')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #f0fdf4;" title="Meadow Green - Xanh l√° r·∫•t nh·∫°t"></button> <button onclick="changeHeaderColor('soft-red')" class="w-12 h-12 rounded-lg border-2 border-gray-300 hover:border-gray-500 transition-colors" style="background-color: #fef2f2;" title="Soft Red - ƒê·ªè r·∫•t nh·∫°t"></button>
    </div>
   </div>
   <div class="bg-white rounded-2xl shadow-lg overflow-hidden mb-8 border-2 border-gray-200">
    <table class="w-full table-fixed border-collapse">
     <thead>
      <tr id="headerRow" style="background-color: #fffbeb; color: #a16207;">
       <th class="text-left p-4 font-semibold border-r first:rounded-tl-2xl" style="border-color: #fbbf24;">Th·ªùi Gian</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© Hai</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© Ba</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© T∆∞</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© NƒÉm</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© S√°u</th>
       <th class="text-center p-4 font-semibold border-r" style="border-color: #fbbf24;">Th·ª© B·∫£y</th>
       <th class="text-center p-4 font-semibold last:rounded-tr-2xl">Ch·ªß Nh·∫≠t</th>
      </tr>
     </thead>
     <tbody id="scheduleTable"><!-- C√°c h√†ng th·ªùi gian s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
     </tbody>
    </table>
   </div>
   <div class="flex flex-wrap gap-3 justify-center mb-8"><button onclick="addNewTimeSlot()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> Th√™m Khung Gi·ªù </button> <button onclick="saveSchedule()" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> L∆∞u Th·ªùi Gian Bi·ªÉu </button> <button onclick="loadSchedule()" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> T·∫£i Th·ªùi Gian Bi·ªÉu </button> <button onclick="clearSchedule()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> X√≥a T·∫•t C·∫£ </button> <button onclick="downloadScheduleImage()" class="bg-purple-500 hover:bg-purple-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> üì± T·∫£i v·ªÅ ƒëi·ªán tho·∫°i </button> <button id="send-to-aggregator" class="bg-orange-500 hover:bg-orange-600 text-white px-6 py-3 rounded-lg font-semibold transition-colors shadow-md hover:shadow-lg"> üì§ G·ª≠i sang T·ªïng h·ª£p </button>
   </div>
   <div class="bg-white rounded-lg p-6 shadow-md">
    <h3 class="text-xl font-semibold text-gray-800 mb-4">H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
    <ul class="text-gray-600 space-y-2">
     <li>‚Ä¢ Nh·∫•p v√†o √¥ th·ªùi gian ƒë·ªÉ ch·ªânh s·ª≠a gi·ªù h·ªçc</li>
     <li>‚Ä¢ Nh·∫•p v√†o √¥ m√¥n h·ªçc ƒë·ªÉ nh·∫≠p t√™n m√¥n v√† ƒë·ªãa ch·ªâ</li>
     <li>‚Ä¢ Nh·∫•p n√∫t "+ Th√™m" ƒë·ªÉ t·∫°o vi·ªác c·∫ßn l√†m m·ªõi</li>
     <li>‚Ä¢ Tick v√†o checkbox khi ho√†n th√†nh t·ª´ng vi·ªác</li>
     <li>‚Ä¢ Nh·∫•n Enter ƒë·ªÉ th√™m vi·ªác ti·∫øp theo, √ó ƒë·ªÉ x√≥a</li>
     <li>‚Ä¢ Nh·∫•p "Th√™m Khung Gi·ªù" ƒë·ªÉ t·∫°o th√™m th·ªùi gian m·ªõi</li>
     <li>‚Ä¢ Di chu·ªôt qua √¥ th·ªùi gian v√† nh·∫•p n√∫t √ó ƒë·ªÉ x√≥a h√†ng</li>
    </ul>
   </div>
  </main><!-- Container ·∫©n ƒë·ªÉ t·∫°o ·∫£nh mobile -->
  <div id="mobileScheduleContainer" class="mobile-schedule"><!-- N·ªôi dung s·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
  </div><!-- Modal ch·ªânh s·ª≠a m√¥n h·ªçc -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
   <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
    <h3 class="text-xl font-semibold mb-4 text-gray-800">Ch·ªânh s·ª≠a th√¥ng tin h·ªçc</h3>
    <div class="space-y-4">
     <div><label for="subjectSelect" class="block text-sm font-medium text-gray-700 mb-1">M√¥n h·ªçc:</label> <select id="subjectSelect" onchange="handleSubjectChange()" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500"> <option value="">-- Ch·ªçn m√¥n h·ªçc --</option> <option value="To√°n">To√°n</option> <option value="Ng·ªØ vƒÉn">Ng·ªØ vƒÉn</option> <option value="Ti·∫øng Anh">Ti·∫øng Anh</option> <option value="V·∫≠t l√≠">V·∫≠t l√≠</option> <option value="H√≥a h·ªçc">H√≥a h·ªçc</option> <option value="Sinh h·ªçc">Sinh h·ªçc</option> <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option> <option value="ƒê·ªãa l√≠">ƒê·ªãa l√≠</option> <option value="Qu·ªëc ph√≤ng">Qu·ªëc ph√≤ng</option> <option value="Mƒ© thu·∫≠t">Mƒ© thu·∫≠t</option> <option value="√Çm nh·∫°c">√Çm nh·∫°c</option> <option value="Tin h·ªçc">Tin h·ªçc</option> <option value="KTPL">KTPL</option> <option value="GDƒêP">GDƒêP</option> <option value="TNHN">TNHN</option> <option value="Th·ªÉ d·ª•c">Th·ªÉ d·ª•c</option> <option value="C√¥ng ngh·ªá">C√¥ng ngh·ªá</option> <option value="other">üñäÔ∏è Nh·∫≠p m√¥n kh√°c...</option> </select> <input type="text" id="customSubjectInput" class="w-full border border-gray-300 rounded-md px-3 py-2 mt-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Nh·∫≠p t√™n m√¥n h·ªçc kh√°c..." style="display: none;">
     </div>
     <div><label for="addressInput" class="block text-sm font-medium text-gray-700 mb-1">ƒê·ªãa ch·ªâ h·ªçc:</label> <input type="text" id="addressInput" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="V√≠ d·ª•: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n 1">
     </div>
    </div>
    <div class="flex gap-3 mt-6"><button onclick="saveEdit()" class="flex-1 bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-md font-medium transition-colors">L∆∞u</button> <button onclick="cancelEdit()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-md font-medium transition-colors">H·ªßy</button> <button onclick="clearCell()" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md font-medium transition-colors">X√≥a</button>
    </div>
   </div>
  </div>
  <script>
        let currentEditCell = null;
        let scheduleData = {};

        // Kh·ªüi t·∫°o th·ªùi gian bi·ªÉu
        function initSchedule() {
            const defaultTimes = [
                '7:00 - 8:00',
                '8:00 - 9:00'
            ];

            defaultTimes.forEach(time => {
                addTimeSlotWithTime(time);
            });

            loadSchedule();
        }



        // Th√™m khung gi·ªù v·ªõi th·ªùi gian c·ª• th·ªÉ
        function addTimeSlotWithTime(timeText) {
            const tableBody = document.getElementById('scheduleTable');
            const row = document.createElement('tr');
            row.className = 'border-b border-gray-200 hover:bg-gray-50';

            // C·ªôt th·ªùi gian
            const timeCell = document.createElement('td');
            timeCell.className = 'time-slot relative p-4 border-r border-gray-200';
            timeCell.style.backgroundColor = '#fffbeb';
            timeCell.style.color = '#a16207';
            timeCell.innerHTML = `
                <div class="text-xs text-gray-600 mb-1">Th·ªùi gian</div>
                <div class="font-semibold text-indigo-800 text-sm editable" onclick="editTime(this.parentElement)">${timeText}</div>
                <button onclick="deleteTimeSlot(this.parentElement.parentElement)" class="delete-btn absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-200" title="X√≥a h√†ng n√†y">√ó</button>
            `;
            row.appendChild(timeCell);

            // 7 c·ªôt cho c√°c ng√†y trong tu·∫ßn
            for (let day = 0; day < 7; day++) {
                const cell = document.createElement('td');
                cell.className = 'editable time-slot p-4 border-r border-gray-200';
                cell.onclick = () => editSubject(cell, timeText, day);
                
                const cellId = `${timeText}-${day}`;
                if (scheduleData[cellId]) {
                    const data = scheduleData[cellId];
                    cell.innerHTML = `
                        <div class="font-semibold text-blue-800">${data.subject}</div>
                        <div class="text-sm text-blue-700 mt-1">${data.address}</div>
                    `;
                }
                
                row.appendChild(cell);
            }

            tableBody.appendChild(row);
            
            // Th√™m h√†ng ghi ch√∫
            const noteRow = document.createElement('tr');
            noteRow.className = 'note-row bg-gray-50 border-b border-gray-200';
            
            // C·ªôt ghi ch√∫ ƒë·∫ßu ti√™n
            const noteHeaderCell = document.createElement('td');
            noteHeaderCell.className = 'p-2 border-r border-gray-200 text-center';
            noteHeaderCell.style.backgroundColor = '#f9fafb';
            noteHeaderCell.innerHTML = `
                <div class="text-xs text-gray-500 font-medium">üìù Ghi ch√∫</div>
            `;
            noteRow.appendChild(noteHeaderCell);
            
            // 7 c·ªôt ghi ch√∫ cho c√°c ng√†y
            for (let day = 0; day < 7; day++) {
                const noteCell = document.createElement('td');
                noteCell.className = 'p-2 border-r border-gray-200';
                noteCell.innerHTML = `
                    <div class="space-y-1">
                        <div class="flex items-center gap-1 mb-1">
                            <button onclick="addNewTask('${timeText}', ${day})" class="text-xs bg-blue-500 hover:bg-blue-600 text-white px-2 py-0.5 rounded transition-colors">+ Th√™m</button>
                        </div>
                        <div id="tasks-${timeText}-${day}" class="space-y-1 max-h-20 overflow-y-auto">
                            <!-- C√°c task s·∫Ω ƒë∆∞·ª£c th√™m v√†o ƒë√¢y -->
                        </div>
                    </div>
                `;
                
                // T·∫£i c√°c task ƒë√£ l∆∞u
                setTimeout(() => {
                    loadTasksForCell(timeText, day);
                }, 10);
                
                noteRow.appendChild(noteCell);
            }
            
            tableBody.appendChild(noteRow);
            
            // C·∫≠p nh·∫≠t class cho h√†ng cu·ªëi c√πng
            updateLastRowClass();
        }

        // Th√™m khung gi·ªù m·ªõi
        function addNewTimeSlot() {
            // T·∫°o modal nh·∫≠p th·ªùi gian t√πy ch·ªânh
            const inputModal = document.createElement('div');
            inputModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            inputModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">‚ûï Th√™m khung gi·ªù m·ªõi</h3>
                    <div class="mb-4">
                        <label for="newTimeInput" class="block text-sm font-medium text-gray-700 mb-2">Nh·∫≠p th·ªùi gian:</label>
                        <input type="text" id="newTimeInput" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="V√≠ d·ª•: 7:00 - 7:45" value="">
                        <p class="text-xs text-gray-500 mt-1">ƒê·ªãnh d·∫°ng: gi·ªù:ph√∫t - gi·ªù:ph√∫t</p>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="confirmAddTimeSlot()" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 rounded-md font-medium transition-colors">Th√™m</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-md font-medium transition-colors">H·ªßy</button>
                    </div>
                </div>
            `;
            document.body.appendChild(inputModal);
            
            // Focus v√†o input
            setTimeout(() => {
                document.getElementById('newTimeInput').focus();
            }, 100);
            
            // X·ª≠ l√Ω ph√≠m Enter
            document.getElementById('newTimeInput').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    confirmAddTimeSlot();
                } else if (e.key === 'Escape') {
                    inputModal.remove();
                }
            });
        }

        // X√°c nh·∫≠n th√™m khung gi·ªù
        function confirmAddTimeSlot() {
            const input = document.getElementById('newTimeInput');
            const newTime = input.value.trim();
            const modal = input.closest('.fixed');
            
            if (newTime) {
                // Ki·ªÉm tra xem th·ªùi gian ƒë√£ t·ªìn t·∫°i ch∆∞a
                const existingTimes = Array.from(document.querySelectorAll('#scheduleTable .editable')).map(el => el.textContent);
                if (existingTimes.includes(newTime)) {
                    showNotification('‚ö†Ô∏è Khung gi·ªù n√†y ƒë√£ t·ªìn t·∫°i!', 'bg-yellow-500');
                    return;
                }
                
                addTimeSlotWithTime(newTime);
                modal.remove();
                saveSchedule();
                showNotification('‚úÖ ƒê√£ th√™m khung gi·ªù m·ªõi!');
            } else {
                showNotification('‚ö†Ô∏è Vui l√≤ng nh·∫≠p th·ªùi gian!', 'bg-yellow-500');
            }
        }

        // X√≥a khung gi·ªù
        function deleteTimeSlot(row) {
            const timeCell = row.querySelector('td:first-child');
            const timeDiv = timeCell.querySelector('.editable');
            const timeText = timeDiv.textContent;
            
            // T·∫°o modal x√°c nh·∫≠n t√πy ch·ªânh thay v√¨ d√πng confirm()
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">‚ö†Ô∏è X√°c nh·∫≠n x√≥a</h3>
                    <p class="text-gray-600 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a khung gi·ªù <strong>"${timeText}"</strong>?<br><br>T·∫•t c·∫£ d·ªØ li·ªáu trong h√†ng n√†y s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
                    <div class="flex gap-3">
                        <button onclick="confirmDeleteRow('${timeText}', this.parentElement.parentElement.parentElement)" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-md font-medium transition-colors">X√≥a</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-md font-medium transition-colors">H·ªßy</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        }

        // X√°c nh·∫≠n x√≥a h√†ng
        function confirmDeleteRow(timeText, modal) {
            // X√≥a d·ªØ li·ªáu li√™n quan (bao g·ªìm c·∫£ tasks)
            for (let day = 0; day < 7; day++) {
                const cellId = `${timeText}-${day}`;
                delete scheduleData[cellId];
                
                // X√≥a t·∫•t c·∫£ tasks thu·ªôc h√†ng n√†y
                if (scheduleData.tasks) {
                    Object.keys(scheduleData.tasks).forEach(taskId => {
                        const task = scheduleData.tasks[taskId];
                        if (task.timeText === timeText && task.dayIndex === day) {
                            delete scheduleData.tasks[taskId];
                        }
                    });
                }
            }
            
            // T√¨m v√† x√≥a c·∫£ h√†ng th·ªùi gian v√† h√†ng ghi ch√∫ kh·ªèi b·∫£ng
            const rows = document.querySelectorAll('#scheduleTable tr');
            let foundTimeRow = false;
            
            rows.forEach(row => {
                const timeCell = row.querySelector('td:first-child .editable');
                if (timeCell && timeCell.textContent === timeText) {
                    foundTimeRow = true;
                    row.remove(); // X√≥a h√†ng th·ªùi gian
                } else if (foundTimeRow && row.classList.contains('note-row')) {
                    row.remove(); // X√≥a h√†ng ghi ch√∫ ngay sau ƒë√≥
                    foundTimeRow = false;
                }
            });
            
            // ƒê√≥ng modal
            modal.remove();
            
            // L∆∞u v√† hi·ªÉn th·ªã th√¥ng b√°o
            saveSchedule();
            updateLastRowClass();
            showNotification('üóëÔ∏è ƒê√£ x√≥a khung gi·ªù!', 'bg-orange-500');
        }

        // Ch·ªânh s·ª≠a th·ªùi gian
        function editTime(cell) {
            const currentTimeDiv = cell.querySelector('.editable');
            const currentTime = currentTimeDiv.textContent;
            
            // T·∫°o input ƒë·ªÉ ch·ªânh s·ª≠a tr·ª±c ti·∫øp
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentTime;
            input.className = 'w-full text-xs font-semibold text-indigo-800 bg-white border border-indigo-300 rounded px-1 py-0.5 focus:outline-none focus:ring-1 focus:ring-indigo-500';
            input.placeholder = '7:00 - 7:45';
            
            // Thay th·∫ø n·ªôi dung √¥ b·∫±ng input
            cell.innerHTML = `
                <div class="text-xs text-gray-600 mb-1">Th·ªùi gian</div>
            `;
            cell.appendChild(input);
            
            // Focus v√† select text
            input.focus();
            input.select();
            
            // X·ª≠ l√Ω khi nh·∫•n Enter ho·∫∑c m·∫•t focus
            function saveTimeEdit() {
                const newTime = input.value.trim();
                if (newTime && newTime !== currentTime) {
                    // C·∫≠p nh·∫≠t d·ªØ li·ªáu
                    const row = cell.parentElement;
                    
                    // Di chuy·ªÉn d·ªØ li·ªáu t·ª´ th·ªùi gian c≈© sang th·ªùi gian m·ªõi
                    for (let day = 0; day < 7; day++) {
                        const oldKey = `${currentTime}-${day}`;
                        const newKey = `${newTime}-${day}`;
                        if (scheduleData[oldKey]) {
                            scheduleData[newKey] = scheduleData[oldKey];
                            delete scheduleData[oldKey];
                        }
                    }
                    
                    // C·∫≠p nh·∫≠t hi·ªÉn th·ªã
                    cell.innerHTML = `
                        <div class="text-xs text-gray-600 mb-1">Th·ªùi gian</div>
                        <div class="font-semibold text-indigo-800 text-xs editable" onclick="editTime(this.parentElement)">${newTime}</div>
                        <button onclick="deleteTimeSlot(this.parentElement.parentElement)" class="delete-btn absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-200" title="X√≥a h√†ng n√†y">√ó</button>
                    `;
                    
                    saveSchedule();
                } else {
                    // Kh√¥i ph·ª•c n·ªôi dung c≈© n·∫øu kh√¥ng c√≥ thay ƒë·ªïi
                    cell.innerHTML = `
                        <div class="text-xs text-gray-600 mb-1">Th·ªùi gian</div>
                        <div class="font-semibold text-indigo-800 text-xs editable" onclick="editTime(this.parentElement)">${currentTime}</div>
                        <button onclick="deleteTimeSlot(this.parentElement.parentElement)" class="delete-btn absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-200" title="X√≥a h√†ng n√†y">√ó</button>
                    `;
                }
            }
            
            // X·ª≠ l√Ω s·ª± ki·ªán
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveTimeEdit();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    // Kh√¥i ph·ª•c n·ªôi dung c≈©
                    cell.innerHTML = `
                        <div class="text-xs text-gray-600 mb-1">Th·ªùi gian</div>
                        <div class="font-semibold text-indigo-800 text-xs editable" onclick="editTime(this.parentElement)">${currentTime}</div>
                        <button onclick="deleteTimeSlot(this.parentElement.parentElement)" class="delete-btn absolute top-1 right-1 bg-red-500 hover:bg-red-600 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center opacity-0 transition-opacity duration-200" title="X√≥a h√†ng n√†y">√ó</button>
                    `;
                }
            });
            
            input.addEventListener('blur', saveTimeEdit);
        }

        // Danh s√°ch m√¥n h·ªçc
        const subjects = [
            'To√°n', 'Ng·ªØ vƒÉn', 'Ti·∫øng Anh', 'V·∫≠t l√≠', 'H√≥a h·ªçc', 'Sinh h·ªçc',
            'L·ªãch s·ª≠', 'ƒê·ªãa l√≠', 'Qu·ªëc ph√≤ng', 'Mƒ© thu·∫≠t', '√Çm nh·∫°c', 'Tin h·ªçc',
            'KTPL', 'GDƒêP', 'TNHN', 'Th·ªÉ d·ª•c', 'C√¥ng ngh·ªá'
        ];

        // Ch·ªânh s·ª≠a m√¥n h·ªçc
        function editSubject(cell, timeText, dayIndex) {
            currentEditCell = { cell, timeText, dayIndex };
            
            const cellId = `${timeText}-${dayIndex}`;
            const existingData = scheduleData[cellId] || { subject: '', address: '' };
            
            // C·∫≠p nh·∫≠t dropdown m√¥n h·ªçc
            updateSubjectDropdown(existingData.subject);
            document.getElementById('addressInput').value = existingData.address;
            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');
            document.getElementById('subjectSelect').focus();
        }

        // C·∫≠p nh·∫≠t dropdown m√¥n h·ªçc
        function updateSubjectDropdown(selectedSubject) {
            const select = document.getElementById('subjectSelect');
            const customInput = document.getElementById('customSubjectInput');
            
            // Ki·ªÉm tra xem m√¥n h·ªçc c√≥ trong danh s√°ch kh√¥ng
            if (subjects.includes(selectedSubject)) {
                select.value = selectedSubject;
                customInput.style.display = 'none';
                customInput.value = '';
            } else if (selectedSubject) {
                select.value = 'other';
                customInput.style.display = 'block';
                customInput.value = selectedSubject;
            } else {
                select.value = '';
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        // X·ª≠ l√Ω thay ƒë·ªïi m√¥n h·ªçc
        function handleSubjectChange() {
            const select = document.getElementById('subjectSelect');
            const customInput = document.getElementById('customSubjectInput');
            
            if (select.value === 'other') {
                customInput.style.display = 'block';
                customInput.focus();
            } else {
                customInput.style.display = 'none';
                customInput.value = '';
            }
        }

        // L∆∞u ch·ªânh s·ª≠a
        function saveEdit() {
            if (!currentEditCell) return;
            
            const select = document.getElementById('subjectSelect');
            const customInput = document.getElementById('customSubjectInput');
            const address = document.getElementById('addressInput').value.trim();
            
            let subject = '';
            if (select.value === 'other') {
                subject = customInput.value.trim();
            } else {
                subject = select.value;
            }
            
            const cellId = `${currentEditCell.timeText}-${currentEditCell.dayIndex}`;
            
            if (subject || address) {
                scheduleData[cellId] = { subject, address };
                currentEditCell.cell.innerHTML = `
                    <div class="font-semibold text-blue-800">${subject}</div>
                    <div class="text-sm text-blue-700 mt-1">${address}</div>
                `;
            } else {
                delete scheduleData[cellId];
                currentEditCell.cell.innerHTML = '';
            }
            
            cancelEdit();
            saveSchedule();
        }

        // X√≥a √¥
        function clearCell() {
            if (!currentEditCell) return;
            
            const cellId = `${currentEditCell.timeText}-${currentEditCell.dayIndex}`;
            delete scheduleData[cellId];
            currentEditCell.cell.innerHTML = '';
            
            cancelEdit();
            saveSchedule();
        }

        // H·ªßy ch·ªânh s·ª≠a
        function cancelEdit() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
            document.getElementById('customSubjectInput').style.display = 'none';
            currentEditCell = null;
        }

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showNotification(message, bgColor = 'bg-green-500') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 ${bgColor} text-white px-4 py-2 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // Hi·ªáu ·ª©ng tr∆∞·ª£t v√†o
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // T·ª± ƒë·ªông ·∫©n sau 3 gi√¢y
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }

        // L∆∞u th·ªùi gian bi·ªÉu
        function saveSchedule() {
            localStorage.setItem('studySchedule', JSON.stringify(scheduleData));
            showNotification('‚úÖ ƒê√£ l∆∞u th·ªùi gian bi·ªÉu!');
        }

        // T·∫£i th·ªùi gian bi·ªÉu
        function loadSchedule() {
            const saved = localStorage.getItem('studySchedule');
            if (saved) {
                scheduleData = JSON.parse(saved);
            }
        }

        // X√≥a t·∫•t c·∫£
        function clearSchedule() {
            // T·∫°o modal x√°c nh·∫≠n t√πy ch·ªânh thay v√¨ d√πng confirm()
            const confirmModal = document.createElement('div');
            confirmModal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            confirmModal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-90vw">
                    <h3 class="text-xl font-semibold mb-4 text-gray-800">‚ö†Ô∏è X√°c nh·∫≠n x√≥a t·∫•t c·∫£</h3>
                    <p class="text-gray-600 mb-6">B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô th·ªùi gian bi·ªÉu?<br><br>T·∫•t c·∫£ d·ªØ li·ªáu s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn.</p>
                    <div class="flex gap-3">
                        <button onclick="confirmClearAll(this.parentElement.parentElement.parentElement)" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-md font-medium transition-colors">X√≥a t·∫•t c·∫£</button>
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 py-2 rounded-md font-medium transition-colors">H·ªßy</button>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmModal);
        }

        // X√°c nh·∫≠n x√≥a t·∫•t c·∫£
        function confirmClearAll(modal) {
            scheduleData = {};
            document.getElementById('scheduleTable').innerHTML = '';
            localStorage.removeItem('studySchedule');
            modal.remove();
            initSchedule();
            showNotification('üóëÔ∏è ƒê√£ x√≥a to√†n b·ªô th·ªùi gian bi·ªÉu!', 'bg-orange-500');
        }



        // Th√™m task m·ªõi
        function addNewTask(timeText, dayIndex) {
            const taskId = `task-${timeText}-${dayIndex}-${Date.now()}`;
            const taskContainer = document.getElementById(`tasks-${timeText}-${dayIndex}`);
            
            const taskDiv = document.createElement('div');
            taskDiv.className = 'flex items-center gap-1 bg-white border border-gray-200 rounded px-1 py-0.5';
            taskDiv.innerHTML = `
                <input type="checkbox" id="${taskId}" onchange="toggleTaskComplete('${taskId}', this.checked)" class="w-3 h-3 text-green-600 rounded focus:ring-green-500 flex-shrink-0">
                <input type="text" placeholder="Nh·∫≠p vi·ªác c·∫ßn l√†m..." class="flex-1 text-xs border-none outline-none bg-transparent" onblur="saveTaskText('${taskId}', this.value)" onkeydown="handleTaskKeydown(event, '${taskId}')">
                <button onclick="deleteTask('${taskId}')" class="text-red-500 hover:text-red-700 text-xs w-4 h-4 flex items-center justify-center flex-shrink-0" title="X√≥a">√ó</button>
            `;
            
            taskContainer.appendChild(taskDiv);
            
            // Focus v√†o input text
            const textInput = taskDiv.querySelector('input[type="text"]');
            textInput.focus();
            
            // Kh·ªüi t·∫°o d·ªØ li·ªáu task
            if (!scheduleData.tasks) scheduleData.tasks = {};
            scheduleData.tasks[taskId] = {
                text: '',
                completed: false,
                timeText: timeText,
                dayIndex: dayIndex
            };
            
            saveSchedule();
        }

        // L∆∞u text c·ªßa task
        function saveTaskText(taskId, text) {
            if (!scheduleData.tasks) scheduleData.tasks = {};
            if (scheduleData.tasks[taskId]) {
                scheduleData.tasks[taskId].text = text.trim();
                
                // N·∫øu text r·ªóng, x√≥a task
                if (!text.trim()) {
                    deleteTask(taskId);
                    return;
                }
            }
            saveSchedule();
        }

        // X·ª≠ l√Ω ph√≠m trong task input
        function handleTaskKeydown(event, taskId) {
            if (event.key === 'Enter') {
                event.preventDefault();
                const taskData = scheduleData.tasks[taskId];
                if (taskData) {
                    addNewTask(taskData.timeText, taskData.dayIndex);
                }
            } else if (event.key === 'Escape') {
                event.target.blur();
            }
        }

        // Toggle ho√†n th√†nh task
        function toggleTaskComplete(taskId, isChecked) {
            if (!scheduleData.tasks) scheduleData.tasks = {};
            if (scheduleData.tasks[taskId]) {
                scheduleData.tasks[taskId].completed = isChecked;
                
                const taskElement = document.getElementById(taskId).parentElement;
                const textInput = taskElement.querySelector('input[type="text"]');
                
                if (isChecked) {
                    textInput.style.textDecoration = 'line-through';
                    textInput.style.opacity = '0.6';
                    taskElement.style.backgroundColor = '#f0f9ff';
                    showNotification('‚úÖ ƒê√£ ho√†n th√†nh!', 'bg-green-500');
                } else {
                    textInput.style.textDecoration = 'none';
                    textInput.style.opacity = '1';
                    taskElement.style.backgroundColor = 'white';
                    showNotification('‚Ü©Ô∏è Ch∆∞a ho√†n th√†nh!', 'bg-blue-500');
                }
            }
            saveSchedule();
        }

        // X√≥a task
        function deleteTask(taskId) {
            const taskElement = document.getElementById(taskId);
            if (taskElement) {
                taskElement.parentElement.remove();
            }
            
            if (scheduleData.tasks && scheduleData.tasks[taskId]) {
                delete scheduleData.tasks[taskId];
            }
            
            saveSchedule();
            showNotification('üóëÔ∏è ƒê√£ x√≥a vi·ªác c·∫ßn l√†m!', 'bg-orange-500');
        }

        // T·∫£i tasks cho m·ªôt √¥ c·ª• th·ªÉ
        function loadTasksForCell(timeText, dayIndex) {
            if (!scheduleData.tasks) return;
            
            const taskContainer = document.getElementById(`tasks-${timeText}-${dayIndex}`);
            if (!taskContainer) return;
            
            // X√≥a c√°c task c≈©
            taskContainer.innerHTML = '';
            
            // T·∫£i c√°c task thu·ªôc √¥ n√†y
            Object.keys(scheduleData.tasks).forEach(taskId => {
                const task = scheduleData.tasks[taskId];
                if (task.timeText === timeText && task.dayIndex === dayIndex) {
                    const taskDiv = document.createElement('div');
                    taskDiv.className = 'flex items-center gap-1 bg-white border border-gray-200 rounded px-1 py-0.5';
                    
                    if (task.completed) {
                        taskDiv.style.backgroundColor = '#f0f9ff';
                    }
                    
                    taskDiv.innerHTML = `
                        <input type="checkbox" id="${taskId}" ${task.completed ? 'checked' : ''} onchange="toggleTaskComplete('${taskId}', this.checked)" class="w-3 h-3 text-green-600 rounded focus:ring-green-500 flex-shrink-0">
                        <input type="text" value="${task.text}" class="flex-1 text-xs border-none outline-none bg-transparent" onblur="saveTaskText('${taskId}', this.value)" onkeydown="handleTaskKeydown(event, '${taskId}')" style="${task.completed ? 'text-decoration: line-through; opacity: 0.6;' : ''}">
                        <button onclick="deleteTask('${taskId}')" class="text-red-500 hover:text-red-700 text-xs w-4 h-4 flex items-center justify-center flex-shrink-0" title="X√≥a">√ó</button>
                    `;
                    
                    taskContainer.appendChild(taskDiv);
                }
            });
        }

        // X·ª≠ l√Ω ph√≠m t·∫Øt
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                cancelEdit();
            }
            if (e.key === 'Enter' && document.getElementById('editModal').classList.contains('flex')) {
                saveEdit();
            }
        });

        // ƒê·ªïi m√†u ti√™u ƒë·ªÅ
        function changeHeaderColor(color) {
            const headerRow = document.getElementById('headerRow');
            const timeCells = document.querySelectorAll('#scheduleTable td:first-child');
            
            // ƒê·ªãnh nghƒ©a m√†u pastel nh·∫°t v√† m√†u ch·ªØ t∆∞∆°ng ·ª©ng
            const colorSchemes = {
                'buttercup': {
                    bg: '#fffbeb',
                    text: '#a16207',
                    border: '#fbbf24'
                },
                'soft-peach': {
                    bg: '#fff7ed',
                    text: '#c2410c',
                    border: '#fb923c'
                },
                'pale-pink': {
                    bg: '#fdf2f8',
                    text: '#be185d',
                    border: '#f472b6'
                },
                'lavender': {
                    bg: '#f5f3ff',
                    text: '#6d28d9',
                    border: '#a78bfa'
                },
                'cool-aqua': {
                    bg: '#f0fdfa',
                    text: '#0f766e',
                    border: '#5eead4'
                },
                'meadow-green': {
                    bg: '#f0fdf4',
                    text: '#166534',
                    border: '#86efac'
                },
                'soft-red': {
                    bg: '#fef2f2',
                    text: '#dc2626',
                    border: '#f87171'
                }
            };
            
            const scheme = colorSchemes[color];
            if (!scheme) return;
            
            // C·∫≠p nh·∫≠t h√†ng ti√™u ƒë·ªÅ
            headerRow.style.backgroundColor = scheme.bg;
            headerRow.style.color = scheme.text;
            
            // C·∫≠p nh·∫≠t border cho c√°c √¥ ti√™u ƒë·ªÅ
            const headerCells = headerRow.querySelectorAll('th');
            headerCells.forEach(cell => {
                cell.style.borderColor = scheme.border;
            });
            
            // C·∫≠p nh·∫≠t c·ªôt th·ªùi gian
            timeCells.forEach(cell => {
                cell.style.backgroundColor = scheme.bg;
                cell.style.color = scheme.text;
            });
            
            // L∆∞u m√†u ƒë√£ ch·ªçn
            localStorage.setItem('headerColor', color);
            showNotification(`üé® ƒê√£ ƒë·ªïi m√†u ti√™u ƒë·ªÅ th√†nh ${getColorName(color)}!`);
        }
        
        // L·∫•y t√™n m√†u hi·ªÉn th·ªã
        function getColorName(color) {
            const names = {
                'buttercup': 'Buttercup (V√†ng nh·∫°t)',
                'soft-peach': 'Soft Peach (Cam nh·∫°t)',
                'pale-pink': 'Pale Pink (H·ªìng nh·∫°t)',
                'lavender': 'Lavender (T√≠m nh·∫°t)',
                'cool-aqua': 'Cool Aqua (Xanh nh·∫°t)',
                'meadow-green': 'Meadow Green (Xanh l√° nh·∫°t)',
                'soft-red': 'Soft Red (ƒê·ªè nh·∫°t)'
            };
            return names[color] || color;
        }
        
        // T·∫£i m√†u ƒë√£ l∆∞u
        function loadSavedColor() {
            const savedColor = localStorage.getItem('headerColor');
            if (savedColor) {
                changeHeaderColor(savedColor);
            } else {
                // M·∫∑c ƒë·ªãnh l√† buttercup n·∫øu ch∆∞a c√≥ m√†u ƒë∆∞·ª£c l∆∞u
                changeHeaderColor('buttercup');
            }
        }

        // C·∫≠p nh·∫≠t class cho h√†ng cu·ªëi c√πng
        function updateLastRowClass() {
            const rows = document.querySelectorAll('#scheduleTable tr');
            
            // X√≥a class last-row kh·ªèi t·∫•t c·∫£ c√°c h√†ng
            rows.forEach(row => row.classList.remove('last-row'));
            
            // Th√™m class last-row cho h√†ng cu·ªëi c√πng
            if (rows.length > 0) {
                rows[rows.length - 1].classList.add('last-row');
            }
        }

        // T·∫£i v·ªÅ ƒëi·ªán tho·∫°i
        function downloadScheduleImage() {
            showNotification('üîÑ ƒêang t·∫°o ·∫£nh cho ƒëi·ªán tho·∫°i...', 'bg-blue-500');
            
            // T·∫°o n·ªôi dung mobile
            generateMobileScheduleContent();
            
            // S·ª≠ d·ª•ng html2canvas ƒë·ªÉ ch·ª•p ·∫£nh
            setTimeout(() => {
                const mobileContainer = document.getElementById('mobileScheduleContainer');
                
                // T·∫°m th·ªùi hi·ªÉn th·ªã container ƒë·ªÉ ch·ª•p ·∫£nh
                mobileContainer.style.position = 'fixed';
                mobileContainer.style.top = '0';
                mobileContainer.style.left = '0';
                mobileContainer.style.zIndex = '9999';
                
                // S·ª≠ d·ª•ng canvas ƒë·ªÉ t·∫°o ·∫£nh
                html2canvas(mobileContainer, {
                    width: 1080,
                    height: 1920,
                    scale: 1,
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: null
                }).then(canvas => {
                    // ·∫®n l·∫°i container
                    mobileContainer.style.position = 'fixed';
                    mobileContainer.style.top = '-9999px';
                    mobileContainer.style.left = '-9999px';
                    mobileContainer.style.zIndex = '-1';
                    
                    // T·∫°o link download
                    const link = document.createElement('a');
                    link.download = `thoi-gian-bieu-${new Date().toISOString().split('T')[0]}.png`;
                    link.href = canvas.toDataURL('image/png');
                    
                    // T·ª± ƒë·ªông download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showNotification('üì± ƒê√£ t·∫£i ·∫£nh v·ªÅ ƒëi·ªán tho·∫°i!', 'bg-green-500');
                }).catch(error => {
                    // ·∫®n l·∫°i container n·∫øu c√≥ l·ªói
                    mobileContainer.style.position = 'fixed';
                    mobileContainer.style.top = '-9999px';
                    mobileContainer.style.left = '-9999px';
                    mobileContainer.style.zIndex = '-1';
                    
                    // Fallback: t·∫°o ·∫£nh b·∫±ng c√°ch kh√°c
                    downloadScheduleImageFallback();
                });
            }, 500);
        }

        // Ph∆∞∆°ng ph√°p d·ª± ph√≤ng ƒë·ªÉ t·∫°o ·∫£nh
        function downloadScheduleImageFallback() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // K√≠ch th∆∞·ªõc mobile (9:16)
            canvas.width = 1080;
            canvas.height = 1920;
            
            // N·ªÅn gradient
            const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
            gradient.addColorStop(0, '#667eea');
            gradient.addColorStop(1, '#764ba2');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Ti√™u ƒë·ªÅ
            ctx.fillStyle = 'white';
            ctx.font = '600 48px Inter, -apple-system, BlinkMacSystemFont, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('L·ªãch Tr√¨nh C√° Nh√¢n', canvas.width / 2, 100);
            
            let yPos = 180;
            
            // L·∫•y d·ªØ li·ªáu t·ª´ b·∫£ng
            const timeSlots = getTimeSlots();
            
            timeSlots.forEach(timeSlot => {
                // Khung th·ªùi gian
                ctx.fillStyle = 'rgba(255,255,255,0.95)';
                ctx.fillRect(40, yPos, canvas.width - 80, 200);
                
                // Th·ªùi gian
                ctx.fillStyle = '#4a5568';
                ctx.font = '600 32px Inter, -apple-system, BlinkMacSystemFont, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(timeSlot.time, canvas.width / 2, yPos + 50);
                
                // C√°c ng√†y
                const days = ['T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'CN'];
                const dayWidth = (canvas.width - 120) / 7;
                
                days.forEach((day, index) => {
                    const dayData = timeSlot.days[index];
                    const x = 60 + index * dayWidth;
                    
                    ctx.fillStyle = '#2d3748';
                    ctx.font = '500 18px Inter, -apple-system, BlinkMacSystemFont, sans-serif';
                    ctx.textAlign = 'left';
                    ctx.fillText(day, x, yPos + 80);
                    
                    if (dayData.subject) {
                        ctx.font = '400 16px Inter, -apple-system, BlinkMacSystemFont, sans-serif';
                        ctx.fillText(dayData.subject, x, yPos + 105);
                    }
                    
                    if (dayData.tasks && dayData.tasks.length > 0) {
                        ctx.font = '400 12px Inter, -apple-system, BlinkMacSystemFont, sans-serif';
                        dayData.tasks.forEach((task, taskIndex) => {
                            const taskY = yPos + 125 + taskIndex * 15;
                            ctx.fillStyle = task.completed ? '#68d391' : '#718096';
                            const taskText = task.completed ? `‚úì ${task.text}` : `‚Ä¢ ${task.text}`;
                            ctx.fillText(taskText.substring(0, 15), x, taskY);
                        });
                    }
                });
                
                yPos += 220;
            });
            
            // T·∫°o link download
            const link = document.createElement('a');
            link.download = `thoi-gian-bieu-${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png');
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('üì± ƒê√£ t·∫£i ·∫£nh v·ªÅ ƒëi·ªán tho·∫°i!', 'bg-green-500');
        }

        // T·∫°o n·ªôi dung mobile schedule
        function generateMobileScheduleContent() {
            const container = document.getElementById('mobileScheduleContainer');
            const timeSlots = getTimeSlots();
            
            let html = '<div class="schedule-title">L·ªãch Tr√¨nh C√° Nh√¢n</div>';
            
            timeSlots.forEach(timeSlot => {
                html += `
                    <div class="time-block">
                        <div class="time-header">${timeSlot.time}</div>
                        <div class="day-grid">
                `;
                
                const dayNames = ['Th·ª© Hai', 'Th·ª© Ba', 'Th·ª© T∆∞', 'Th·ª© NƒÉm', 'Th·ª© S√°u', 'Th·ª© B·∫£y', 'Ch·ªß Nh·∫≠t'];
                
                timeSlot.days.forEach((dayData, index) => {
                    if (dayData.subject || (dayData.tasks && dayData.tasks.length > 0)) {
                        html += `
                            <div class="day-item">
                                <div class="day-name">${dayNames[index]}</div>
                                ${dayData.subject ? `<div class="subject">${dayData.subject}</div>` : ''}
                                ${dayData.address ? `<div class="address">${dayData.address}</div>` : ''}
                                ${dayData.tasks && dayData.tasks.length > 0 ? `
                                    <div class="tasks">
                                        ${dayData.tasks.map(task => 
                                            `<div class="task-item ${task.completed ? 'task-completed' : ''}">${task.completed ? '‚úì' : '‚Ä¢'} ${task.text}</div>`
                                        ).join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                });
                
                html += '</div></div>';
            });
            
            container.innerHTML = html;
        }

        // L·∫•y d·ªØ li·ªáu th·ªùi gian bi·ªÉu
        function getTimeSlots() {
            const timeSlots = [];
            const rows = document.querySelectorAll('#scheduleTable tr:not(.note-row)');
            
            rows.forEach(row => {
                const timeCell = row.querySelector('td:first-child .editable');
                if (timeCell) {
                    const timeText = timeCell.textContent;
                    const days = [];
                    
                    // L·∫•y d·ªØ li·ªáu 7 ng√†y
                    for (let day = 0; day < 7; day++) {
                        const cellId = `${timeText}-${day}`;
                        const cellData = scheduleData[cellId] || { subject: '', address: '' };
                        
                        // L·∫•y tasks
                        const tasks = [];
                        if (scheduleData.tasks) {
                            Object.keys(scheduleData.tasks).forEach(taskId => {
                                const task = scheduleData.tasks[taskId];
                                if (task.timeText === timeText && task.dayIndex === day && task.text) {
                                    tasks.push({
                                        text: task.text,
                                        completed: task.completed || false
                                    });
                                }
                            });
                        }
                        
                        days.push({
                            subject: cellData.subject,
                            address: cellData.address,
                            tasks: tasks
                        });
                    }
                    
                    timeSlots.push({
                        time: timeText,
                        days: days
                    });
                }
            });
            
            return timeSlots;
        }

        // Th√™m th∆∞ vi·ªán html2canvas
        function loadHtml2Canvas() {
            if (typeof html2canvas === 'undefined') {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                script.onload = function() {
                    console.log('html2canvas loaded');
                };
                document.head.appendChild(script);
            }
        }

        // ===== C·∫§U H√åNH T·ªîNG H·ª¢P =====
        const AGGREGATOR_URL = "https://nckhthptnk.github.io/tonghoplichhoc/"; // Trang t·ªïng h·ª£p
        const AGGREGATOR_ORIGIN = new URL(AGGREGATOR_URL).origin;
        const SOURCE_ID = 'lichtrinhcanhan';

        // Thu th·∫≠p d·ªØ li·ªáu th·ªùi gian bi·ªÉu
        function collectScheduleData() {
            const data = {
                scheduleData: scheduleData,
                timeSlots: getTimeSlots(),
                headerColor: localStorage.getItem('headerColor') || 'buttercup'
            };
            return data;
        }

        // M·ªü trang t·ªïng h·ª£p v√† g·ª≠i d·ªØ li·ªáu
        let aggregatorWin = null;
        function openAggregatorAndSend(payload) {
            if (!aggregatorWin || aggregatorWin.closed) {
                aggregatorWin = window.open(AGGREGATOR_URL, '_blank');
                // G·ª≠i l·∫∑p v√†i l·∫ßn ƒë·ªÉ ch·∫Øc ch·∫Øn nh·∫≠n ƒë∆∞·ª£c
                let tries = 0;
                const iv = setInterval(() => {
                    tries++;
                    try { 
                        aggregatorWin.postMessage(payload, AGGREGATOR_ORIGIN); 
                    } catch(e) {}
                    if (tries > 10) clearInterval(iv);
                }, 500);
            } else {
                aggregatorWin.focus();
                aggregatorWin.postMessage(payload, AGGREGATOR_ORIGIN);
            }
        }

        // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c t·∫£i
        document.addEventListener('DOMContentLoaded', function() {
            // X√≥a d·ªØ li·ªáu c≈©
            localStorage.removeItem('studySchedule');
            localStorage.removeItem('headerColor');
            scheduleData = {};
            
            initSchedule();
            // T·∫£i m√†u sau khi kh·ªüi t·∫°o b·∫£ng
            setTimeout(loadSavedColor, 100);
            
            // T·∫£i th∆∞ vi·ªán html2canvas
            loadHtml2Canvas();

            // X·ª≠ l√Ω n√∫t g·ª≠i sang t·ªïng h·ª£p
            document.getElementById('send-to-aggregator')?.addEventListener('click', () => {
                const data = collectScheduleData();
                const payload = {
                    type: 'TKB_DATA',
                    source: SOURCE_ID,
                    url: location.href,
                    timestamp: Date.now(),
                    data
                };
                openAggregatorAndSend(payload);
                showNotification('üì§ ƒê√£ g·ª≠i d·ªØ li·ªáu sang trang t·ªïng h·ª£p!', 'bg-orange-500');
            });
        });
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9969067cd57add53',t:'MTc2MTgwNzUxOS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>

